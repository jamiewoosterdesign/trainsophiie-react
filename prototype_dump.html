<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Sophiie - Redesign Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        },
                        slate: {
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617', // Deeper navy for sidebar
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pop-in': 'popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1)'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 12px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            line-height: 1.4;
            animation: fadeIn 0.3s ease-out;
        }

        .user-bubble {
            background-color: #eff6ff;
            color: #1e3a8a;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            margin-left: auto;
        }

        .bot-bubble {
            background-color: #f1f5f9;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .system-bubble {
            font-size: 0.75rem;
            color: #64748b;
            text-align: center;
            margin: 10px 0;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        /* Pricing Radio Styles */
        .pricing-radio:checked+div {
            border-color: #3b82f6;
            color: #2563eb;
            background-color: #eff6ff;
            font-weight: 600;
        }

        .pricing-dot {
            display: none;
        }

        .pricing-radio:checked+div .pricing-dot {
            display: block;
        }

        /* View Switching Logic */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: flex;
        }

        .nav-item.active {
            color: #60a5fa;
            /* brand-400 */
        }

        /* Nav Item hover/active logic for the dark sidebar */
        .nav-icon-btn {
            position: relative;
        }

        .nav-icon-btn.active::after {
            content: '';
            position: absolute;
            left: -12px;
            /* Pull to edge */
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background-color: #60a5fa;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex overflow-hidden text-slate-800">

    <!-- TIER 1: Sidebar -->
    <aside class="w-[72px] bg-[#020617] flex flex-col items-center py-6 z-30 flex-shrink-0 shadow-xl text-white">
        <div class="mb-10 text-2xl opacity-90 hover:opacity-100 cursor-pointer">
            <i class="fa-solid fa-headset"></i>
        </div>

        <nav class="flex-1 w-full flex flex-col gap-7 px-2 items-center">
            <a href="#" class="text-xl text-white opacity-60 hover:opacity-100 transition-opacity nav-icon-btn">
                <i class="fa-regular fa-envelope"></i>
            </a>

            <!-- People (Staff View Trigger) -->
            <a href="#" onclick="switchView('staff')" id="nav-staff"
                class="text-xl text-white opacity-60 hover:opacity-100 transition-all nav-icon-btn">
                <i class="fa-solid fa-user-group"></i>
            </a>

            <!-- Wrench (Services View Trigger) -->
            <a href="#" onclick="switchView('services')" id="nav-services"
                class="text-xl text-white opacity-60 hover:opacity-100 transition-all nav-icon-btn active">
                <i class="fa-solid fa-screwdriver-wrench"></i>
            </a>

            <!-- Protocols (Trigger) -->
            <a href="#" onclick="switchView('protocols')" id="nav-protocols"
                class="text-xl text-white opacity-60 hover:opacity-100 transition-all nav-icon-btn">
                <i class="fa-solid fa-list-check"></i>
            </a>

            <!-- Transfers (Trigger) -->
            <a href="#" onclick="switchView('transfers')" id="nav-transfers"
                class="text-xl text-white opacity-60 hover:opacity-100 transition-all nav-icon-btn">
                <i class="fa-solid fa-arrow-right-arrow-left"></i>
            </a>

            <a href="#" class="text-xl text-white opacity-60 hover:opacity-100 transition-opacity nav-icon-btn">
                <i class="fa-regular fa-calendar"></i>
            </a>

            <a href="#" class="text-xl text-white opacity-60 hover:opacity-100 transition-opacity nav-icon-btn">
                <i class="fa-solid fa-list-check"></i>
            </a>

            <a href="#"
                class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center text-brand-400 mt-2 mb-2">
                <i class="fa-solid fa-robot text-lg"></i>
            </a>

            <a href="#" class="text-xl text-white opacity-60 hover:opacity-100 transition-opacity nav-icon-btn">
                <i class="fa-solid fa-gear"></i>
            </a>

            <a href="#" class="text-xl text-white opacity-60 hover:opacity-100 transition-opacity nav-icon-btn">
                <i class="fa-regular fa-circle-question"></i>
            </a>
        </nav>

        <div
            class="mt-4 w-10 h-10 rounded-xl bg-gradient-to-b from-lime-400 to-emerald-500 cursor-pointer shadow-lg hover:opacity-90 transition-opacity">
        </div>
    </aside>

    <!-- TIER 2: Inner Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col h-full flex-shrink-0 z-20">
        <div class="p-6 border-b border-gray-100">
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Module</h2>
            <div class="text-lg font-bold text-slate-800 flex items-center gap-2">
                Train Sophiie
                <span class="bg-brand-100 text-brand-700 text-[10px] px-2 py-0.5 rounded-full">Beta</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-8">
            <!-- Group: Knowledge Base -->
            <div>
                <h3 class="px-2 text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Knowledge Base</h3>
                <ul class="space-y-1">
                    <li>
                        <a href="#" onclick="switchView('services')" id="sub-services"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-brand-50 text-brand-700 font-medium">
                            <i class="fa-solid fa-wrench w-5 text-brand-500"></i>
                            Services
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="switchView('protocols')" id="sub-protocols"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors">
                            <i class="fa-solid fa-shield-halved w-5 text-slate-400"></i>
                            Protocols
                        </a>
                    </li>
                    <li>
                        <a href="#"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors">
                            <i class="fa-solid fa-file-shield w-5 text-slate-400"></i>
                            Policies
                        </a>
                    </li>
                    <li>
                        <a href="#"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors">
                            <i class="fa-solid fa-circle-question w-5 text-slate-400"></i>
                            FAQs
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Group: Team & Routing -->
            <div>
                <h3 class="px-2 text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Team & Routing</h3>
                <ul class="space-y-1">
                    <li>
                        <a href="#" onclick="switchView('staff')" id="sub-staff"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors">
                            <i class="fa-solid fa-users w-5 text-slate-400"></i>
                            Staff
                        </a>
                    </li>
                    <li>
                        <a href="#"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors">
                            <i class="fa-solid fa-sitemap w-5 text-slate-400"></i>
                            Departments
                        </a>
                    </li>
                    <!-- New Transfers Link -->
                    <li>
                        <a href="#" onclick="switchView('transfers')" id="sub-transfers"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors">
                            <i class="fa-solid fa-arrow-right-arrow-left w-5 text-slate-400"></i>
                            Transfers
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Group: Persona -->
            <div>
                <h3 class="px-2 text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Persona</h3>
                <ul class="space-y-1">
                    <li>
                        <a href="#"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors">
                            <i class="fa-solid fa-microphone-lines w-5 text-slate-400"></i>
                            Voice & Tone
                        </a>
                    </li>
                    <li>
                        <a href="#"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors">
                            <i class="fa-solid fa-hand-sparkles w-5 text-slate-400"></i>
                            Greetings
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="p-4 border-t border-gray-100 bg-gray-50/50">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-semibold text-slate-500">Setup Progress</span>
                <span class="text-xs font-bold text-brand-600">85%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                <div class="bg-brand-500 h-1.5 rounded-full" style="width: 85%"></div>
            </div>
        </div>
    </aside>

    <!-- 3. Main Content Area -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-white">

        <!-- VIEW 1: SERVICES DASHBOARD -->
        <div id="view-services" class="view-section active flex-col h-full">
            <header class="bg-white border-b border-gray-100 px-8 py-5 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Services Configuration</h1>
                    <p class="text-slate-500 text-sm mt-1">Teach Sophiie what services you offer and how to handle them.
                    </p>
                </div>
                <button onclick="openWizard('service')"
                    class="bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 rounded-lg shadow-sm font-medium flex items-center gap-2 transition-all active:scale-95">
                    <i class="fa-solid fa-plus"></i> Add New Service
                </button>
            </header>

            <div class="flex-1 overflow-y-auto p-8 bg-gray-50/50">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Service Card 1 -->
                    <div
                        class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all group cursor-pointer relative overflow-hidden hover:-translate-y-1">
                        <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-green-50 text-green-600 rounded-lg">
                                <i class="fa-solid fa-faucet text-xl"></i>
                            </div>
                            <span
                                class="text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-gray-500 px-2 py-1 rounded">Active</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-900 mb-1">Emergency Plumbing</h3>
                        <p class="text-sm text-slate-500 mb-4 line-clamp-2">Handling burst pipes, leaks, and overflowing
                            toilets.</p>
                        <div
                            class="flex items-center justify-between text-sm text-slate-400 pt-4 border-t border-gray-100">
                            <span class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> 60 min</span>
                            <span class="flex items-center gap-1"><i class="fa-solid fa-share-nodes"></i>
                                Transfer</span>
                        </div>
                    </div>
                    <!-- Service Card 2 -->
                    <div
                        class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all group cursor-pointer relative overflow-hidden hover:-translate-y-1">
                        <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                                <i class="fa-solid fa-fire-burner text-xl"></i>
                            </div>
                            <span
                                class="text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-gray-500 px-2 py-1 rounded">Active</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-900 mb-1">Gas Fitting</h3>
                        <p class="text-sm text-slate-500 mb-4 line-clamp-2">Installation and maintenance of gas
                            appliances.</p>
                        <div
                            class="flex items-center justify-between text-sm text-slate-400 pt-4 border-t border-gray-100">
                            <span class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> 90 min</span>
                            <span class="flex items-center gap-1"><i class="fa-regular fa-calendar-check"></i>
                                Book</span>
                        </div>
                    </div>
                    <!-- Add New Placeholder -->
                    <button onclick="openWizard('service')"
                        class="border-2 border-dashed border-gray-300 rounded-xl p-6 flex flex-col items-center justify-center text-gray-400 hover:border-brand-500 hover:text-brand-500 hover:bg-brand-50/50 transition-all bg-transparent h-full min-h-[240px]">
                        <div
                            class="w-12 h-12 rounded-full bg-white shadow-sm border border-gray-200 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-plus text-lg text-brand-500"></i>
                        </div>
                        <span class="font-medium">Create New Service</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: STAFF DASHBOARD -->
        <div id="view-staff" class="view-section flex-col h-full">
            <header class="bg-white border-b border-gray-100 px-8 py-5 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Team & Routing</h1>
                    <p class="text-slate-500 text-sm mt-1">Manage team members and configure call transfer logic.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openGlobalSettings()"
                        class="bg-white border border-gray-200 hover:bg-gray-50 text-slate-600 px-4 py-2.5 rounded-lg shadow-sm font-medium flex items-center gap-2 transition-all">
                        <i class="fa-solid fa-sliders"></i> Global Settings
                    </button>
                    <button onclick="openWizard('staff')"
                        class="bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 rounded-lg shadow-sm font-medium flex items-center gap-2 transition-all active:scale-95">
                        <i class="fa-solid fa-plus"></i> Add Team Member
                    </button>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-8 bg-gray-50/50">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Staff Card 1 -->
                    <div
                        class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all group cursor-pointer relative overflow-hidden hover:-translate-y-1">
                        <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-sm">
                                JT</div>
                            <span
                                class="text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-gray-500 px-2 py-1 rounded">Owner</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-900 mb-1">Jamie Tester</h3>
                        <p class="text-sm text-slate-500 mb-4 line-clamp-2">Handles billing disputes, large quotes, and
                            complex customer complaints.</p>
                        <div
                            class="flex items-center justify-between text-sm text-slate-400 pt-4 border-t border-gray-100">
                            <span class="flex items-center gap-1.5 text-green-600 font-medium"><i
                                    class="fa-solid fa-circle text-[8px]"></i> Available</span>
                            <span class="flex items-center gap-1.5"><i class="fa-solid fa-phone"></i> x444</span>
                        </div>
                    </div>
                    <!-- Staff Card 2 -->
                    <div
                        class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all group cursor-pointer relative overflow-hidden hover:-translate-y-1">
                        <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center font-bold text-sm">
                                SB</div>
                            <span
                                class="text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-gray-500 px-2 py-1 rounded">Recept.</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-900 mb-1">Sarah Brown</h3>
                        <p class="text-sm text-slate-500 mb-4 line-clamp-2">General inquiries, booking appointments,
                            basic triage.</p>
                        <div
                            class="flex items-center justify-between text-sm text-slate-400 pt-4 border-t border-gray-100">
                            <span class="flex items-center gap-1.5 text-amber-600 font-medium"><i
                                    class="fa-regular fa-clock"></i> Back 2pm</span>
                            <span class="flex items-center gap-1.5"><i class="fa-solid fa-phone"></i> x101</span>
                        </div>
                    </div>
                    <!-- Add New Placeholder -->
                    <button onclick="openWizard('staff')"
                        class="border-2 border-dashed border-gray-300 rounded-xl p-6 flex flex-col items-center justify-center text-gray-400 hover:border-brand-500 hover:text-brand-500 hover:bg-brand-50/50 transition-all bg-transparent h-full min-h-[240px]">
                        <div
                            class="w-12 h-12 rounded-full bg-white shadow-sm border border-gray-200 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-plus text-lg text-brand-500"></i>
                        </div>
                        <span class="font-medium">Add Team Member</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW 3: PROTOCOLS DASHBOARD -->
        <div id="view-protocols" class="view-section flex-col h-full">
            <header class="bg-white border-b border-gray-100 px-8 py-5 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Protocols & Behavior</h1>
                    <p class="text-slate-500 text-sm mt-1">Define global guardrails and specific operational workflows.
                    </p>
                </div>
                <button onclick="openWizard('protocol')"
                    class="bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 rounded-lg shadow-sm font-medium flex items-center gap-2 transition-all active:scale-95">
                    <i class="fa-solid fa-plus"></i> Add Protocol
                </button>
            </header>

            <div class="flex-1 overflow-y-auto p-8 bg-gray-50/50 space-y-8">

                <!-- Section 1: Specific Workflows -->
                <div>
                    <div class="flex items-center gap-2 mb-4">
                        <div class="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg"><i class="fa-solid fa-route"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800">Specific Workflows</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Workflow Card -->
                        <div
                            class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all cursor-pointer group">
                            <div class="flex justify-between items-start mb-3">
                                <span
                                    class="text-xs font-bold uppercase tracking-wide text-indigo-600 bg-indigo-50 px-2 py-1 rounded">If
                                    / Then</span>
                                <button class="text-gray-300 hover:text-gray-500"><i
                                        class="fa-solid fa-ellipsis"></i></button>
                            </div>
                            <h4 class="font-bold text-slate-900 mb-1">Refund Request</h4>
                            <p class="text-xs text-slate-500 mb-4">Trigger: User asks for money back.</p>
                            <div
                                class="flex items-center gap-2 text-xs text-slate-600 bg-gray-50 p-2 rounded border border-gray-100">
                                <i class="fa-solid fa-arrow-right-long text-gray-400"></i>
                                <span>Transfer to Accounts Team</span>
                            </div>
                        </div>

                        <!-- Workflow Card -->
                        <div
                            class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all cursor-pointer group">
                            <div class="flex justify-between items-start mb-3">
                                <span
                                    class="text-xs font-bold uppercase tracking-wide text-indigo-600 bg-indigo-50 px-2 py-1 rounded">If
                                    / Then</span>
                                <button class="text-gray-300 hover:text-gray-500"><i
                                        class="fa-solid fa-ellipsis"></i></button>
                            </div>
                            <h4 class="font-bold text-slate-900 mb-1">Job Application</h4>
                            <p class="text-xs text-slate-500 mb-4">Trigger: User wants to work here.</p>
                            <div
                                class="flex items-center gap-2 text-xs text-slate-600 bg-gray-50 p-2 rounded border border-gray-100">
                                <i class="fa-solid fa-arrow-right-long text-gray-400"></i>
                                <span>Direct to website / Careers</span>
                            </div>
                        </div>

                        <!-- Add New Workflow -->
                        <button onclick="openWizard('protocol')"
                            class="border-2 border-dashed border-gray-300 rounded-xl p-5 flex flex-col items-center justify-center text-gray-400 hover:border-brand-500 hover:text-brand-500 hover:bg-brand-50/50 transition-all bg-transparent min-h-[140px]">
                            <i class="fa-solid fa-plus mb-2"></i>
                            <span class="text-sm font-medium">Create Workflow</span>
                        </button>
                    </div>
                </div>

                <!-- Section 2: Global Guardrails -->
                <div>
                    <div class="flex items-center gap-2 mb-4">
                        <div class="p-1.5 bg-red-100 text-red-600 rounded-lg"><i class="fa-solid fa-shield-halved"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800">Global Restrictions & Guardrails</h3>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                        <p class="text-sm text-slate-500 mb-6">Define strict limits for the AI. These are
                            <strong>negative constraints</strong> that apply to every call.</p>

                        <div class="space-y-4">
                            <!-- Guardrail Item 1 -->
                            <div
                                class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                                <div class="flex items-center gap-3">
                                    <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                                    <div class="text-sm text-slate-700">
                                        <span class="font-bold text-slate-600 uppercase text-xs mr-1">Sophiie Must
                                            Never</span>
                                        quote specific pricing unless explicitly listed in Services.
                                    </div>
                                </div>
                                <button class="text-gray-400 hover:text-red-500"><i
                                        class="fa-solid fa-trash"></i></button>
                            </div>

                            <!-- Guardrail Item 2 -->
                            <div
                                class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                                <div class="flex items-center gap-3">
                                    <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                                    <div class="text-sm text-slate-700">
                                        <span class="font-bold text-slate-600 uppercase text-xs mr-1">Sophiie Must
                                            Never</span>
                                        promise specific arrival times (give 2hr windows only).
                                    </div>
                                </div>
                                <button class="text-gray-400 hover:text-red-500"><i
                                        class="fa-solid fa-trash"></i></button>
                            </div>

                            <!-- Strict Input Area -->
                            <div class="flex items-center gap-2 pt-3 mt-2 border-t border-gray-100">
                                <div class="flex-1 relative">
                                    <div
                                        class="absolute left-4 top-3 text-slate-500 font-bold text-sm select-none pointer-events-none uppercase tracking-wide text-xs">
                                        Sophiie must NEVER</div>
                                    <input type="text"
                                        class="w-full pl-40 pr-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 bg-white placeholder-gray-400"
                                        placeholder="e.g. discuss politics or religion...">
                                </div>
                                <button
                                    class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 px-5 py-2.5 rounded-lg text-sm font-bold transition-colors shadow-sm">
                                    Add Restriction
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- VIEW 4: TRANSFERS DASHBOARD -->
        <div id="view-transfers" class="view-section flex-col h-full">
            <header class="bg-white border-b border-gray-100 px-8 py-5 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Transfers Configuration</h1>
                    <p class="text-slate-500 text-sm mt-1">Manage call transfer rules and logic.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openGlobalSettings()"
                        class="bg-white border border-gray-200 hover:bg-gray-50 text-slate-600 px-4 py-2.5 rounded-lg shadow-sm font-medium flex items-center gap-2 transition-all">
                        <i class="fa-solid fa-sliders"></i> Global Settings
                    </button>
                    <button onclick="openWizard('transfer')"
                        class="bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 rounded-lg shadow-sm font-medium flex items-center gap-2 transition-all active:scale-95">
                        <i class="fa-solid fa-plus"></i> Add Transfer Rule
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 bg-gray-50/50">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Transfer Card 1 -->
                    <div
                        class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all group cursor-pointer relative overflow-hidden hover:-translate-y-1">
                        <div class="absolute top-0 left-0 w-1 h-full bg-orange-500"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-orange-50 text-orange-600 rounded-lg">
                                <i class="fa-solid fa-people-arrows text-xl"></i>
                            </div>
                            <span
                                class="text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-gray-500 px-2 py-1 rounded">Warm</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-900 mb-1">Sales Department</h3>
                        <p class="text-sm text-slate-500 mb-4 line-clamp-2">When someone wants to speak to sales.</p>
                        <div
                            class="flex items-center justify-between text-sm text-slate-400 pt-4 border-t border-gray-100">
                            <span class="flex items-center gap-1"><i class="fa-solid fa-building"></i> Sales Dept</span>
                        </div>
                    </div>
                    <!-- Transfer Card 2 -->
                    <div
                        class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all group cursor-pointer relative overflow-hidden hover:-translate-y-1">
                        <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                                <i class="fa-solid fa-user-check text-xl"></i>
                            </div>
                            <span
                                class="text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-gray-500 px-2 py-1 rounded">Warm</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-900 mb-1">Transfer to John</h3>
                        <p class="text-sm text-slate-500 mb-4 line-clamp-2">Direct transfer for John's personal clients.
                        </p>
                        <div
                            class="flex items-center justify-between text-sm text-slate-400 pt-4 border-t border-gray-100">
                            <span class="flex items-center gap-1"><i class="fa-solid fa-user"></i> John Doe</span>
                        </div>
                    </div>
                    <!-- Add New Placeholder -->
                    <button onclick="openWizard('transfer')"
                        class="border-2 border-dashed border-gray-300 rounded-xl p-6 flex flex-col items-center justify-center text-gray-400 hover:border-brand-500 hover:text-brand-500 hover:bg-brand-50/50 transition-all bg-transparent h-full min-h-[240px]">
                        <div
                            class="w-12 h-12 rounded-full bg-white shadow-sm border border-gray-200 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-plus text-lg text-brand-500"></i>
                        </div>
                        <span class="font-medium">Add Transfer Rule</span>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- GLOBAL SETTINGS MODAL -->
    <div id="globalSettingsModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center transition-opacity opacity-0">
        <div class="bg-white w-[500px] rounded-xl shadow-2xl overflow-hidden transform scale-95 transition-transform">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-slate-800">Global Transfer Settings</h3>
                <button onclick="closeGlobalSettings()" class="text-gray-400 hover:text-gray-600"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Transfer Timeout (Seconds)</label>
                    <input type="number" value="30"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none text-sm">
                    <p class="text-xs text-slate-500 mt-1">How long Sophiie waits before pulling the call back.</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Hold Music / Message</label>
                    <textarea rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none text-sm">Please hold while I transfer you to a member of the team...</textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Fallback Action</label>
                    <select
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none text-sm bg-white">
                        <option>Take a message</option>
                        <option>Return to AI agent</option>
                        <option>Hang up</option>
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-100 flex justify-end">
                <button onclick="closeGlobalSettings()"
                    class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-brand-700">Save
                    Settings</button>
            </div>
        </div>
    </div>

    <!-- WIZARD MODAL -->
    <div id="wizardModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity opacity-0">
        <div class="bg-white w-[90vw] max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex overflow-hidden transform scale-95 transition-transform duration-300 relative"
            id="wizardContent">

            <!-- LEFT COLUMN: The Wizard Form -->
            <div class="w-3/5 flex flex-col border-r border-gray-200">
                <!-- Modal Header -->
                <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center">
                    <div>
                        <h2 id="wizardTitle" class="text-xl font-bold text-slate-900">Add New Service</h2>
                        <div class="flex items-center gap-2 mt-2">
                            <!-- Progress Indicators -->
                            <div class="flex items-center gap-2">
                                <span id="step-dot-1"
                                    class="w-2.5 h-2.5 rounded-full bg-brand-600 transition-colors"></span>
                                <span class="text-xs font-semibold text-brand-600 transition-colors"
                                    id="step-label-1">Basics</span>
                            </div>
                            <div class="w-8 h-px bg-gray-200"></div>
                            <div class="flex items-center gap-2">
                                <span id="step-dot-2"
                                    class="w-2.5 h-2.5 rounded-full bg-gray-300 transition-colors"></span>
                                <span class="text-xs font-semibold text-gray-400 transition-colors"
                                    id="step-label-2">Knowledge</span>
                            </div>
                            <div class="w-8 h-px bg-gray-200"></div>
                            <div class="flex items-center gap-2">
                                <span id="step-dot-3"
                                    class="w-2.5 h-2.5 rounded-full bg-gray-300 transition-colors"></span>
                                <span class="text-xs font-semibold text-gray-400 transition-colors"
                                    id="step-label-3">Outcome</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="attemptClose()"
                        class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>

                <!-- Form Content Area -->
                <div class="flex-1 overflow-y-auto p-8 relative">

                    <!-- SERVICE FORM CONTAINER -->
                    <div id="serviceFormContainer">
                        <div id="service-step-1" class="wizard-step active animate-fade-in">
                            <div class="mb-6"><label class="block text-sm font-semibold text-slate-700 mb-2">Service
                                    Name</label><input type="text" id="serviceNameInput"
                                    placeholder="e.g., Leaking Tap Repair"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all"
                                    oninput="updatePreview('service')">
                                <p class="text-xs text-slate-500 mt-2 flex items-start gap-2"><i
                                        class="fa-solid fa-circle-info text-brand-500 mt-0.5"></i> This is what Sophiie
                                    listens for. Be specific but common.</p>
                            </div>
                            <div class="mb-6"><label class="block text-sm font-semibold text-slate-700 mb-3">Service
                                    Pricing Mode</label>
                                <div class="flex gap-3 mb-4 overflow-x-auto pb-1"><label class="cursor-pointer"><input
                                            type="radio" name="priceMode" value="fixed" class="pricing-radio hidden"
                                            checked onchange="updatePriceInput()">
                                        <div
                                            class="px-4 py-2 border border-gray-200 rounded-full text-sm text-slate-600 hover:bg-gray-50 transition-colors flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full bg-brand-500 pricing-dot"></div>Fixed Price
                                        </div>
                                    </label><label class="cursor-pointer"><input type="radio" name="priceMode"
                                            value="hourly" class="pricing-radio hidden" onchange="updatePriceInput()">
                                        <div
                                            class="px-4 py-2 border border-gray-200 rounded-full text-sm text-slate-600 hover:bg-gray-50 transition-colors flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full bg-brand-500 pricing-dot"></div>Hourly Rate
                                        </div>
                                    </label><label class="cursor-pointer"><input type="radio" name="priceMode"
                                            value="range" class="pricing-radio hidden" onchange="updatePriceInput()">
                                        <div
                                            class="px-4 py-2 border border-gray-200 rounded-full text-sm text-slate-600 hover:bg-gray-50 transition-colors flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full bg-brand-500 pricing-dot"></div>Price Range
                                        </div>
                                    </label><label class="cursor-pointer"><input type="radio" name="priceMode"
                                            value="na" class="pricing-radio hidden" onchange="updatePriceInput()">
                                        <div
                                            class="px-4 py-2 border border-gray-200 rounded-full text-sm text-slate-600 hover:bg-gray-50 transition-colors flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full bg-brand-500 pricing-dot"></div>Not
                                            Applicable
                                        </div>
                                    </label></div>
                                <div class="relative" id="priceInputContainer"><span
                                        class="absolute left-3 top-3.5 text-gray-500">$</span><input type="number"
                                        id="priceInput" placeholder="Enter fixed price amount..."
                                        class="w-full pl-8 pr-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none transition-all">
                                </div>
                            </div>
                            <div><label class="block text-sm font-semibold text-slate-700 mb-2">Avg.
                                    Duration</label><select
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                                    <option>30 mins</option>
                                    <option selected>60 mins</option>
                                    <option>90 mins</option>
                                    <option>2 hours</option>
                                </select></div>
                        </div>
                        <div id="service-step-2" class="wizard-step animate-fade-in">
                            <div class="mb-6"><label
                                    class="block text-sm font-semibold text-slate-700 mb-2">Description</label>
                                <div class="relative"><textarea id="serviceDescInput" rows="3"
                                        placeholder="Describe what this service entails. e.g., We fix dripping taps, replace washers, and reseat taps..."
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none transition-all resize-none pr-20"
                                        oninput="updatePreview('service')"></textarea>
                                    <div class="absolute bottom-3 right-3 flex items-center gap-2"><button
                                            class="w-7 h-7 rounded-full bg-gray-50 hover:bg-gray-100 text-gray-400 hover:text-brand-600 transition-all flex items-center justify-center"
                                            title="Voice Input"><i
                                                class="fa-solid fa-microphone text-xs"></i></button><button
                                            class="w-7 h-7 rounded-full bg-gray-50 hover:bg-brand-50 text-gray-400 hover:text-brand-600 transition-all flex items-center justify-center"
                                            title="Generate with AI"><i
                                                class="fa-solid fa-wand-magic-sparkles text-xs"></i></button></div>
                                </div>
                            </div>
                            <div><label class="block text-sm font-semibold text-slate-700 mb-2">Pre-Qualifying
                                    Questions</label>
                                <div id="questionsList" class="space-y-3 mb-3">
                                    <div class="flex gap-2">
                                        <div
                                            class="flex-1 bg-gray-50 px-3 py-2.5 rounded-lg border border-gray-200 text-sm text-slate-700 flex items-center justify-between group">
                                            <span>Is the water currently turned off?</span><button
                                                class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i
                                                    class="fa-solid fa-trash"></i></button></div>
                                    </div>
                                </div>
                                <div class="flex gap-2"><input type="text" id="newQuestionInput"
                                        placeholder="Type a question and press Enter..."
                                        class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none text-sm"><button
                                        onclick="addQuestion()"
                                        class="bg-gray-100 hover:bg-gray-200 text-slate-700 px-4 py-2 rounded-lg font-medium text-sm transition-colors">Add</button>
                                </div>
                            </div>
                        </div>
                        <div id="service-step-3" class="wizard-step animate-fade-in">
                            <label class="block text-sm font-semibold text-slate-700 mb-4">When this service is
                                identified, what should Sophiie do?</label>
                            <div class="grid grid-cols-3 gap-4 mb-6"><label class="cursor-pointer group"><input
                                        type="radio" name="outcome" value="transfer" class="peer hidden" checked
                                        onchange="updatePreview('service')">
                                    <div
                                        class="h-full p-4 rounded-xl border-2 border-gray-200 peer-checked:border-brand-500 peer-checked:bg-brand-50 hover:border-gray-300 transition-all flex flex-col items-center text-center">
                                        <div
                                            class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-phone-flip"></i></div><span
                                            class="font-semibold text-sm text-slate-800">Transfer Call</span><span
                                            class="text-xs text-slate-500 mt-1">Connect to a human</span>
                                    </div>
                                </label><label class="cursor-pointer group"><input type="radio" name="outcome"
                                        value="book" class="peer hidden" onchange="updatePreview('service')">
                                    <div
                                        class="h-full p-4 rounded-xl border-2 border-gray-200 peer-checked:border-brand-500 peer-checked:bg-brand-50 hover:border-gray-300 transition-all flex flex-col items-center text-center">
                                        <div
                                            class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-calendar-check"></i></div><span
                                            class="font-semibold text-sm text-slate-800">Book Job</span><span
                                            class="text-xs text-slate-500 mt-1">Schedule appointment</span>
                                    </div>
                                </label><label class="cursor-pointer group"><input type="radio" name="outcome"
                                        value="info" class="peer hidden" onchange="updatePreview('service')">
                                    <div
                                        class="h-full p-4 rounded-xl border-2 border-gray-200 peer-checked:border-brand-500 peer-checked:bg-brand-50 hover:border-gray-300 transition-all flex flex-col items-center text-center">
                                        <div
                                            class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-paper-plane"></i></div><span
                                            class="font-semibold text-sm text-slate-800">Send Info</span><span
                                            class="text-xs text-slate-500 mt-1">Email or SMS details</span>
                                    </div>
                                </label></div>
                            <div id="transferConfig"
                                class="bg-gray-50 p-4 rounded-lg border border-gray-200 animate-fade-in relative"><label
                                    class="block text-sm font-semibold text-slate-700 mb-2">Select Team or
                                    Department</label><button id="customSelectTrigger" onclick="toggleDropdown()"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-white text-left text-sm flex justify-between items-center focus:ring-2 focus:ring-brand-500 outline-none"><span
                                        id="selectedValue">Reception Desk (Default)</span><i
                                        class="fa-solid fa-chevron-down text-gray-400"></i></button>
                                <div id="customSelectMenu"
                                    class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-gray-200 rounded-xl shadow-xl z-50 overflow-hidden max-h-72 flex flex-col animate-pop-in origin-top">
                                    <div class="p-3 border-b border-gray-100 bg-gray-50">
                                        <div class="relative"><i
                                                class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-xs"></i><input
                                                type="text" placeholder="Search team..."
                                                class="w-full pl-8 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:border-brand-500"
                                                onkeyup="filterOptions(this)"></div>
                                    </div>
                                    <div class="overflow-y-auto flex-1 p-1" id="dropdownOptions">
                                        <div
                                            class="px-3 py-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">
                                            Departments</div>
                                        <div class="option-item px-3 py-2 rounded-lg hover:bg-brand-50 text-sm cursor-pointer text-slate-700 flex items-center gap-2"
                                            onclick="selectOption('Reception Desk (Default)')">
                                            <div
                                                class="w-6 h-6 rounded bg-purple-100 text-purple-600 flex items-center justify-center text-xs">
                                                <i class="fa-solid fa-users"></i></div>Reception Desk (Default)
                                        </div>
                                        <div
                                            class="px-3 py-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider mt-1">
                                            Staff Members</div>
                                        <div class="option-item px-3 py-2 rounded-lg hover:bg-brand-50 text-sm cursor-pointer text-slate-700 flex items-center gap-2"
                                            onclick="selectOption('Jamie Tester (Owner)')">
                                            <div
                                                class="w-6 h-6 rounded bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">
                                                JT</div>Jamie Tester
                                        </div>
                                    </div>
                                    <div class="p-2 border-t border-gray-100 bg-gray-50"><button
                                            onclick="switchToStaffFlow()"
                                            class="w-full py-2 px-3 rounded-lg bg-white border border-dashed border-gray-300 text-brand-600 text-sm font-medium hover:bg-brand-50 hover:border-brand-300 transition-all flex items-center justify-center gap-2"><i
                                                class="fa-solid fa-plus"></i> Add New Team Member</button></div>
                                </div>
                            </div>
                            <div id="bookConfig"
                                class="bg-gray-50 p-4 rounded-lg border border-gray-200 animate-fade-in hidden"><label
                                    class="block text-sm font-semibold text-slate-700 mb-2">Link Calendar</label>
                                <div class="flex items-center gap-2 text-sm text-gray-600"><i
                                        class="fa-brands fa-google text-red-500"></i> Main Plumbing Calendar (Synced)
                                </div>
                            </div>
                            <div id="infoConfig"
                                class="bg-gray-50 p-4 rounded-lg border border-gray-200 animate-fade-in hidden"><label
                                    class="block text-sm font-semibold text-slate-700 mb-3">Choose Delivery
                                    Methods</label>
                                <div class="space-y-3"><label
                                        class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:border-brand-400 transition-colors"><input
                                            type="checkbox" id="checkSMS" checked
                                            class="w-5 h-5 text-brand-600 rounded focus:ring-brand-500"
                                            onchange="updatePreview('service')">
                                        <div class="flex-1"><span class="block font-medium text-sm text-slate-800"><i
                                                    class="fa-solid fa-mobile-screen mr-2 text-gray-400"></i>Send via
                                                SMS</span></div>
                                    </label><label
                                        class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:border-brand-400 transition-colors"><input
                                            type="checkbox" id="checkEmail"
                                            class="w-5 h-5 text-brand-600 rounded focus:ring-brand-500"
                                            onchange="updatePreview('service')">
                                        <div class="flex-1"><span class="block font-medium text-sm text-slate-800"><i
                                                    class="fa-solid fa-envelope mr-2 text-gray-400"></i>Send via
                                                Email</span></div>
                                    </label></div>
                            </div>
                        </div>
                    </div>

                    <!-- STAFF FORM CONTAINER -->
                    <div id="staffFormContainer" class="hidden">
                        <div id="staff-step-1" class="wizard-step active animate-fade-in">
                            <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-4 flex items-center gap-3 text-sm text-blue-800 hidden"
                                id="nestedStaffAlert"><i class="fa-solid fa-info-circle"></i><span>Creating new member
                                    for Service Rule.</span></div>
                            <div class="grid grid-cols-2 gap-6 mb-6">
                                <div><label class="block text-sm font-semibold text-slate-700 mb-2">First
                                        Name</label><input type="text" id="staffNameInput" placeholder="e.g., Sarah"
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none"
                                        oninput="updatePreview('staff')"></div>
                                <div><label class="block text-sm font-semibold text-slate-700 mb-2">Last
                                        Name</label><input type="text" placeholder="e.g., Connor"
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none">
                                </div>
                            </div>
                            <!-- NEW: Combined Role & Department -->
                            <div class="mb-6"><label class="block text-sm font-semibold text-slate-700 mb-2">Role &
                                    Department</label>
                                <div class="flex shadow-sm rounded-lg"><input type="text" id="staffRoleInput"
                                        placeholder="e.g., Senior Accounts Manager"
                                        class="flex-1 px-4 py-3 rounded-l-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none z-10"
                                        oninput="updatePreview('staff')"><select
                                        class="w-2/5 px-4 py-3 bg-gray-50 border border-l-0 border-gray-300 rounded-r-lg focus:ring-2 focus:ring-brand-500 outline-none text-slate-600 text-sm cursor-pointer hover:bg-gray-100 transition-colors">
                                        <option value="" disabled selected>Assign Department...</option>
                                        <option>Reception Desk (Default)</option>
                                        <option>Sales Department</option>
                                        <option>Emergency Team</option>
                                        <option>Accounts & Billing</option>
                                    </select></div>
                            </div>
                            <div class="grid grid-cols-2 gap-6 mb-6">
                                <div><label class="block text-sm font-semibold text-slate-700 mb-2">Phone</label><input
                                        type="tel" placeholder="+1..."
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none">
                                </div>
                                <div><label class="block text-sm font-semibold text-slate-700 mb-2">Email</label><input
                                        type="email" placeholder="@company.com"
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none">
                                </div>
                            </div>
                            <!-- NEW: Access Level -->
                            <div class="mb-2"><label class="block text-sm font-semibold text-slate-700 mb-3">Platform
                                    Access Level</label>
                                <div class="flex gap-4"><label class="flex-1 relative cursor-pointer group"><input
                                            type="radio" name="accessLevel" value="user" class="peer hidden" checked>
                                        <div
                                            class="p-3 border border-gray-200 rounded-lg hover:border-brand-300 peer-checked:border-brand-500 peer-checked:bg-brand-50 transition-all flex items-start gap-3">
                                            <div
                                                class="mt-0.5 w-4 h-4 rounded-full border border-gray-300 peer-checked:border-brand-500 peer-checked:border-4 bg-white transition-all">
                                            </div>
                                            <div>
                                                <div class="font-semibold text-slate-800 text-sm">Standard User</div>
                                                <div class="text-xs text-slate-500 mt-0.5 leading-snug">Can handle calls
                                                    & manage own schedule.</div>
                                            </div>
                                        </div>
                                    </label><label class="flex-1 relative cursor-pointer group"><input type="radio"
                                            name="accessLevel" value="admin" class="peer hidden">
                                        <div
                                            class="p-3 border border-gray-200 rounded-lg hover:border-brand-300 peer-checked:border-brand-500 peer-checked:bg-brand-50 transition-all flex items-start gap-3">
                                            <div
                                                class="mt-0.5 w-4 h-4 rounded-full border border-gray-300 peer-checked:border-brand-500 peer-checked:border-4 bg-white transition-all">
                                            </div>
                                            <div>
                                                <div class="font-semibold text-slate-800 text-sm">Administrator</div>
                                                <div class="text-xs text-slate-500 mt-0.5 leading-snug">Full access to
                                                    settings, billing & staff.</div>
                                            </div>
                                        </div>
                                    </label></div>
                            </div>
                        </div>
                        <div id="staff-step-2" class="wizard-step animate-fade-in">
                            <div class="mb-6"><label
                                    class="block text-sm font-semibold text-slate-700 mb-2">Responsibilities &
                                    Expertise</label>
                                <p class="text-xs text-slate-500 mb-2">Tell Sophiie what this person handles so she
                                    knows when to transfer calls to them.</p>
                                <div class="relative"><textarea id="staffRespInput" rows="4"
                                        placeholder="e.g., Handles all billing disputes, late invoices, and high-value client accounts..."
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none resize-none pr-20"
                                        oninput="updatePreview('staff')"></textarea>
                                    <div class="absolute bottom-3 right-3 flex items-center gap-2"><button
                                            class="w-7 h-7 rounded-full bg-gray-50 hover:bg-gray-100 text-gray-400 hover:text-brand-600 transition-all flex items-center justify-center"
                                            title="Voice Input"><i
                                                class="fa-solid fa-microphone text-xs"></i></button><button
                                            class="w-7 h-7 rounded-full bg-gray-50 hover:bg-brand-50 text-gray-400 hover:text-brand-600 transition-all flex items-center justify-center"
                                            title="Generate with AI"><i
                                                class="fa-solid fa-wand-magic-sparkles text-xs"></i></button></div>
                                </div>
                            </div>
                            <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 flex items-start gap-3"><i
                                    class="fa-solid fa-lightbulb text-blue-500 mt-0.5"></i>
                                <div class="text-sm text-blue-800"><strong>AI Tip:</strong> Be specific. Instead of
                                    "Sales", say "Residential Sales and Quotes".</div>
                            </div>
                        </div>
                        <div id="staff-step-3" class="wizard-step animate-fade-in">
                            <label class="block text-sm font-semibold text-slate-700 mb-4">Transfer Conditions</label>
                            <div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200"><label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Specific
                                    Keywords</label>
                                <p class="text-xs text-slate-400 mb-3">If a user says these, transfer immediately.</p>
                                <div class="flex flex-wrap gap-2 mb-2"><span
                                        class="bg-white border border-gray-300 px-3 py-1 rounded-full text-sm flex items-center gap-2">"Billing
                                        Issue" <i
                                            class="fa-solid fa-xmark text-gray-400 cursor-pointer hover:text-red-500"></i></span><button
                                        class="text-brand-600 text-sm font-medium hover:underline">+ Add
                                        Keyword</button></div>
                            </div>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <div class="font-medium text-slate-800 text-sm">Escalation Point</div>
                                        <div class="text-xs text-slate-500">Route angry/escalated calls here</div>
                                    </div><label class="relative inline-flex items-center cursor-pointer"><input
                                            type="checkbox" class="sr-only peer" onchange="updatePreview('staff')">
                                        <div
                                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-600">
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PROTOCOL FORM CONTAINER -->
                    <div id="protocolFormContainer" class="hidden">
                        <div id="protocol-step-1" class="wizard-step active animate-fade-in">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Trigger Condition</label>
                            <p class="text-xs text-slate-500 mb-4">When should this protocol be activated?</p>
                            <div class="grid grid-cols-2 gap-4 mb-6"><label class="cursor-pointer group"><input
                                        type="radio" name="protocolTrigger" value="keyword" class="peer hidden" checked
                                        onchange="updateProtocolPlaceholder()">
                                    <div
                                        class="p-4 border-2 border-gray-200 rounded-lg hover:border-brand-400 transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 h-full">
                                        <div class="font-semibold text-slate-800 mb-1">Specific Keywords</div>
                                        <div class="text-xs text-slate-500">Exact phrases (e.g., "Refund")</div>
                                    </div>
                                </label><label class="cursor-pointer group"><input type="radio" name="protocolTrigger"
                                        value="intent" class="peer hidden" onchange="updateProtocolPlaceholder()">
                                    <div
                                        class="p-4 border-2 border-gray-200 rounded-lg hover:border-brand-400 transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 h-full">
                                        <div class="font-semibold text-slate-800 mb-1">Customer Intent</div>
                                        <div class="text-xs text-slate-500">Vague goals (e.g., Wants a job)</div>
                                    </div>
                                </label></div><input type="text" id="protocolTriggerInput"
                                placeholder="Enter specific keywords (comma separated)..."
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none">
                        </div>
                        <div id="protocol-step-2" class="wizard-step active animate-fade-in">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Required Action</label>
                            <p class="text-xs text-slate-500 mb-4">What must Sophiie do in this situation?</p><select
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none bg-white mb-4"
                                id="protocolActionSelect" onchange="updatePreview('protocol')">
                                <option value="script">Follow a Script / Give Info</option>
                                <option value="transfer">Transfer to Team</option>
                                <option value="refuse">Politely Refuse</option>
                                <option value="collect">Collect Info & Park</option>
                            </select>
                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200"><label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Response
                                    Script / Note</label><textarea rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none text-sm"
                                    placeholder="e.g. We do not offer refunds on sale items..."></textarea></div>
                        </div>
                        <div id="protocol-step-3" class="wizard-step animate-fade-in">
                            <div class="text-center py-8">
                                <div
                                    class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                                    <i class="fa-solid fa-check"></i></div>
                                <h3 class="text-lg font-bold text-slate-800 mb-2">Protocol Ready</h3>
                                <p class="text-slate-500 text-sm max-w-xs mx-auto">This logic will now override general
                                    AI behavior when triggered.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TRANSFER FORM CONTAINER (New) -->
                    <div id="transferFormContainer" class="hidden">
                        <div id="transfer-step-1" class="wizard-step active animate-fade-in">
                            <div class="mb-6"><label class="block text-sm font-semibold text-slate-700 mb-2">Transfer
                                    Rule Name</label><input type="text" id="transferNameInput"
                                    placeholder="e.g., Sales Inquiry"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none transition-all"
                                    oninput="updatePreview('transfer')"></div>
                            <div class="mb-6"><label class="block text-sm font-semibold text-slate-700 mb-3">Transfer
                                    Type</label>
                                <div class="grid grid-cols-2 gap-4"><label class="cursor-pointer group"><input
                                            type="radio" name="transferType" value="warm" class="peer hidden" checked>
                                        <div
                                            class="p-4 border-2 border-gray-200 rounded-lg hover:border-brand-400 transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 h-full">
                                            <div class="flex items-center gap-2 mb-1">
                                                <div class="p-1 bg-orange-100 text-orange-600 rounded text-xs"><i
                                                        class="fa-solid fa-mug-hot"></i></div>
                                                <div class="font-semibold text-slate-800">Warm Transfer</div>
                                            </div>
                                            <div class="text-xs text-slate-500">AI introduces caller to agent first.
                                            </div>
                                        </div>
                                    </label><label class="cursor-pointer group"><input type="radio" name="transferType"
                                            value="cold" class="peer hidden">
                                        <div
                                            class="p-4 border-2 border-gray-200 rounded-lg hover:border-brand-400 transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 h-full">
                                            <div class="flex items-center gap-2 mb-1">
                                                <div class="p-1 bg-blue-100 text-blue-600 rounded text-xs"><i
                                                        class="fa-solid fa-snowflake"></i></div>
                                                <div class="font-semibold text-slate-800">Cold Transfer</div>
                                            </div>
                                            <div class="text-xs text-slate-500">Immediate connect, no introduction.
                                            </div>
                                        </div>
                                    </label></div>
                            </div>
                        </div>
                        <div id="transfer-step-2" class="wizard-step animate-fade-in">
                            <div class="mb-6"><label class="block text-sm font-semibold text-slate-700 mb-2">Summary
                                    Format (Handoff Message)</label>
                                <p class="text-xs text-slate-500 mb-3">What should the AI say to the human agent before
                                    connecting?</p>
                                <div class="relative"><textarea id="transferSummaryInput" rows="4"
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none text-sm leading-relaxed font-mono bg-gray-50"
                                        oninput="updatePreview('transfer')">Hi, I have {Caller Name} on the line who needs assistance with {Reason}. They mentioned {Key Details}.</textarea>
                                    <div class="absolute bottom-3 right-3 flex items-center gap-2"><button
                                            class="w-7 h-7 rounded-full bg-white border border-gray-200 hover:bg-brand-50 text-gray-400 hover:text-brand-600 transition-all flex items-center justify-center shadow-sm"
                                            title="Reset to Default"><i
                                                class="fa-solid fa-rotate-left text-xs"></i></button></div>
                                </div>
                                <div class="mt-3 flex flex-wrap gap-2"><span
                                        class="text-xs font-semibold text-slate-400 uppercase tracking-wide mr-1">Variables:</span><span
                                        class="px-2 py-1 bg-gray-100 rounded border border-gray-200 text-xs text-slate-600 cursor-pointer hover:bg-white hover:border-brand-300 hover:text-brand-600 transition-colors">{Caller
                                        Name}</span><span
                                        class="px-2 py-1 bg-gray-100 rounded border border-gray-200 text-xs text-slate-600 cursor-pointer hover:bg-white hover:border-brand-300 hover:text-brand-600 transition-colors">{Reason}</span><span
                                        class="px-2 py-1 bg-gray-100 rounded border border-gray-200 text-xs text-slate-600 cursor-pointer hover:bg-white hover:border-brand-300 hover:text-brand-600 transition-colors">{Key
                                        Details}</span></div>
                            </div>
                        </div>
                        <div id="transfer-step-3" class="wizard-step animate-fade-in">
                            <label class="block text-sm font-semibold text-slate-700 mb-4">Routing Logic</label>
                            <div class="mb-4"><label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Transfer
                                    To</label><select
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none bg-white text-sm">
                                    <option>Specific Person</option>
                                    <option>Department (Round Robin)</option>
                                    <option>External Number</option>
                                </select></div>
                            <div class="mb-6"><label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Select
                                    Person</label><select
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 outline-none bg-white text-sm">
                                    <option>Jamie Tester</option>
                                    <option>Sarah Brown</option>
                                </select></div>
                            <div
                                class="flex items-center justify-between p-4 border border-gray-200 rounded-lg bg-gray-50">
                                <div>
                                    <div class="font-medium text-slate-800 text-sm">Ignore Business Hours</div>
                                    <div class="text-xs text-slate-500">Transfer even if closed (e.g. Emergency)</div>
                                </div><label class="relative inline-flex items-center cursor-pointer"><input
                                        type="checkbox" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-600">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Footer Buttons -->
                <div
                    class="px-8 py-5 border-t border-gray-100 bg-gray-50 rounded-bl-2xl flex justify-between items-center">
                    <button id="backBtn" onclick="prevStep()"
                        class="px-5 py-2.5 rounded-lg text-slate-600 font-medium hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>Back</button>
                    <button id="nextBtn" onclick="nextStep()"
                        class="px-6 py-2.5 rounded-lg bg-brand-600 text-white font-medium hover:bg-brand-700 shadow-md transition-all active:scale-95">Next
                        Step</button>
                </div>
            </div>

            <!-- RIGHT COLUMN: Live Simulator -->
            <div class="w-2/5 bg-slate-50 flex flex-col relative border-l border-gray-200">
                <div
                    class="absolute top-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-200 to-transparent opacity-50">
                </div>

                <!-- Simulator Header -->
                <div
                    class="px-6 py-4 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-10">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-xs font-bold uppercase tracking-wide text-slate-500">Live Simulation</span>
                    </div>
                    <button onclick="resetPreview()" class="text-xs text-brand-600 hover:text-brand-800 font-medium"><i
                            class="fa-solid fa-rotate-right mr-1"></i> Reset</button>
                </div>

                <!-- Chat Area -->
                <div class="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar" id="chatContainer">
                    <!-- Dynamic Content -->
                </div>

                <!-- Input Placeholder (Visual only) -->
                <div class="p-4 bg-white border-t border-gray-200">
                    <div class="flex gap-2">
                        <div
                            class="h-10 bg-gray-100 rounded-full flex-1 border border-transparent flex items-center px-4 text-gray-400 text-sm italic">
                            Customer is speaking...
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-brand-100 text-brand-500 flex items-center justify-center">
                            <i class="fa-solid fa-microphone"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Save Confirmation Modal -->
    <!-- ... (same as before) ... -->
    <div id="saveConfirmModal"
        class="fixed inset-0 bg-slate-900/40 z-[60] hidden flex items-center justify-center backdrop-blur-[2px]">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96 transform scale-100 animate-pop-in">
            <div class="text-center mb-5">
                <div
                    class="w-12 h-12 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-solid fa-floppy-disk text-xl"></i></div>
                <h3 class="text-lg font-bold text-slate-800">Save progress?</h3>
                <p class="text-slate-500 text-sm mt-1">You have unsaved changes.</p>
            </div>
            <div class="space-y-3">
                <button onclick="saveAndClose()"
                    class="w-full bg-brand-600 hover:bg-brand-700 text-white font-medium py-2.5 rounded-lg transition-colors">Save
                    Draft</button>
                <button onclick="discardAndClose()"
                    class="w-full bg-white border border-gray-200 text-slate-600 hover:bg-gray-50 font-medium py-2.5 rounded-lg transition-colors">Discard
                    Changes</button>
                <button onclick="toggleSaveModal(false)"
                    class="w-full text-slate-400 hover:text-slate-600 text-sm font-medium py-1">Keep Editing</button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let currentStep = 1;
        const totalSteps = 3;
        let hasUnsavedChanges = false;
        let wizardMode = 'service'; // 'service', 'staff', 'protocol', 'transfer'
        let isNestedStaffFlow = false;

        // DOM Elements
        const modal = document.getElementById('wizardModal');
        const modalContent = document.getElementById('wizardContent');
        const backBtn = document.getElementById('backBtn');
        const nextBtn = document.getElementById('nextBtn');
        const chatContainer = document.getElementById('chatContainer');
        const priceInput = document.getElementById('priceInput');
        const priceInputContainer = document.getElementById('priceInputContainer');

        // Inputs
        const nameInput = document.getElementById('serviceNameInput');
        const descInput = document.getElementById('serviceDescInput');
        const newQuestionInput = document.getElementById('newQuestionInput');
        const questionsList = document.getElementById('questionsList');

        modalContent.addEventListener('input', () => hasUnsavedChanges = true);
        modalContent.addEventListener('change', () => hasUnsavedChanges = true);

        // --- CUSTOM DROPDOWN LOGIC ---
        function toggleDropdown() {
            document.getElementById('customSelectMenu').classList.toggle('hidden');
        }
        function selectOption(value) {
            document.getElementById('selectedValue').innerText = value;
            toggleDropdown();
        }
        function filterOptions(input) {
            const filter = input.value.toUpperCase();
            const div = document.getElementById("dropdownOptions");
            const options = div.getElementsByClassName("option-item");
            for (let i = 0; i < options.length; i++) {
                const txtValue = options[i].textContent || options[i].innerText;
                options[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
        }

        // --- VIEW SWITCHING ---
        let currentView = 'services';

        function switchView(viewName) {
            currentView = viewName;

            // Update Views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');

            // Update Sidebar Active
            document.querySelectorAll('.nav-icon-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${viewName}`).classList.add('active');

            // Update Submenu Highlights (Reset all first)
            document.getElementById('sub-services').className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors";
            document.getElementById('sub-staff').className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors";
            document.getElementById('sub-protocols').className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors";
            // Check if element exists before accessing class (as it was newly added)
            if (document.getElementById('sub-transfers')) {
                document.getElementById('sub-transfers').className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-gray-50 hover:text-slate-900 transition-colors";
            }

            const activeClass = "flex items-center gap-3 px-3 py-2.5 rounded-lg bg-brand-50 text-brand-700 font-medium";
            if (viewName === 'services') document.getElementById('sub-services').className = activeClass;
            if (viewName === 'staff') document.getElementById('sub-staff').className = activeClass;
            if (viewName === 'protocols') document.getElementById('sub-protocols').className = activeClass;
            if (viewName === 'transfers' && document.getElementById('sub-transfers')) document.getElementById('sub-transfers').className = activeClass;
        }

        // --- GLOBAL SETTINGS ---
        function openGlobalSettings() {
            const el = document.getElementById('globalSettingsModal');
            el.classList.remove('hidden');
            setTimeout(() => { el.classList.remove('opacity-0'); el.querySelector('div').classList.remove('scale-95'); }, 10);
        }
        function closeGlobalSettings() {
            const el = document.getElementById('globalSettingsModal');
            el.classList.add('opacity-0');
            el.querySelector('div').classList.add('scale-95');
            setTimeout(() => el.classList.add('hidden'), 300);
        }

        // --- WIZARD LOGIC ---
        function openWizard(mode) {
            wizardMode = mode || 'service';
            isNestedStaffFlow = false;

            configureWizardUI(wizardMode);

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
            resetWizard();
        }

        function switchToStaffFlow() {
            isNestedStaffFlow = true;
            wizardMode = 'staff';
            document.getElementById('customSelectMenu').classList.add('hidden');
            configureWizardUI('staff');
            document.getElementById('staffNameInput').value = '';
            document.getElementById('staffRoleInput').value = '';

            currentStep = 1;
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
            document.getElementById('staff-step-1').classList.add('active');
            updateStepperUI();
        }

        function returnToServiceFlow() {
            wizardMode = 'service';
            isNestedStaffFlow = false;
            configureWizardUI('service');

            currentStep = 3;
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
            document.getElementById('service-step-3').classList.add('active');
            updateStepperUI();
            document.getElementById('selectedValue').innerText = "New Team Member";
        }

        function configureWizardUI(mode) {
            // Hide all first
            document.getElementById('serviceFormContainer').classList.add('hidden');
            document.getElementById('staffFormContainer').classList.add('hidden');
            document.getElementById('protocolFormContainer').classList.add('hidden');
            document.getElementById('transferFormContainer').classList.add('hidden');
            document.getElementById('nestedStaffAlert').classList.add('hidden');

            if (mode === 'service') {
                document.getElementById('serviceFormContainer').classList.remove('hidden');
                document.getElementById('wizardTitle').innerText = 'Add New Service';
                document.getElementById('step-label-1').innerText = 'Basics';
                document.getElementById('step-label-2').innerText = 'Knowledge';
                document.getElementById('step-label-3').innerText = 'Outcome';
            } else if (mode === 'staff') {
                document.getElementById('staffFormContainer').classList.remove('hidden');
                document.getElementById('wizardTitle').innerText = 'Add Team Member';
                document.getElementById('step-label-1').innerText = 'Profile';
                document.getElementById('step-label-2').innerText = 'Responsibilities';
                document.getElementById('step-label-3').innerText = 'Transfer Rules';
                if (isNestedStaffFlow) document.getElementById('nestedStaffAlert').classList.remove('hidden');
            } else if (mode === 'protocol') {
                document.getElementById('protocolFormContainer').classList.remove('hidden');
                document.getElementById('wizardTitle').innerText = 'Add New Protocol';
                document.getElementById('step-label-1').innerText = 'Trigger';
                document.getElementById('step-label-2').innerText = 'Action';
                document.getElementById('step-label-3').innerText = 'Review';
            } else if (mode === 'transfer') {
                document.getElementById('transferFormContainer').classList.remove('hidden');
                document.getElementById('wizardTitle').innerText = 'Add Transfer Rule';
                document.getElementById('step-label-1').innerText = 'Strategy';
                document.getElementById('step-label-2').innerText = 'Handoff';
                document.getElementById('step-label-3').innerText = 'Routing';
            }
        }

        function attemptClose() {
            if (hasUnsavedChanges) toggleSaveModal(true);
            else closeWizard();
        }

        function closeWizard() {
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) attemptClose();
        });

        function toggleSaveModal(show) {
            const el = document.getElementById('saveConfirmModal');
            show ? el.classList.remove('hidden') : el.classList.add('hidden');
        }

        function saveAndClose() {
            toggleSaveModal(false);
            if (isNestedStaffFlow) returnToServiceFlow();
            else closeWizard();
        }

        function discardAndClose() {
            toggleSaveModal(false);
            if (isNestedStaffFlow) returnToServiceFlow();
            else closeWizard();
        }

        function updatePriceInput() {
            const mode = document.querySelector('input[name="priceMode"]:checked').value;
            priceInput.disabled = false;
            priceInputContainer.style.opacity = '1';
            if (mode === 'fixed') priceInput.placeholder = 'Enter fixed price amount...';
            else if (mode === 'hourly') priceInput.placeholder = 'Enter hourly rate...';
            else if (mode === 'range') { priceInput.placeholder = 'Enter min - max...'; priceInput.type = "text"; }
            else if (mode === 'na') { priceInput.placeholder = 'Price not applicable'; priceInput.disabled = true; priceInputContainer.style.opacity = '0.5'; priceInput.value = ''; }
            if (mode !== 'range') priceInput.type = "number";
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                const currentStepId = `${wizardMode}-step-${currentStep}`;
                const nextStepId = `${wizardMode}-step-${currentStep + 1}`;
                document.getElementById(currentStepId).classList.remove('active');
                currentStep++;
                document.getElementById(nextStepId).classList.add('active');
                updateStepperUI();
            } else {
                if (isNestedStaffFlow) returnToServiceFlow();
                else saveAndClose();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                const currentStepId = `${wizardMode}-step-${currentStep}`;
                const prevStepId = `${wizardMode}-step-${currentStep - 1}`;
                document.getElementById(currentStepId).classList.remove('active');
                currentStep--;
                document.getElementById(prevStepId).classList.add('active');
                updateStepperUI();
            } else {
                if (isNestedStaffFlow) returnToServiceFlow();
            }
        }

        function updateStepperUI() {
            for (let i = 1; i <= totalSteps; i++) {
                const dot = document.getElementById(`step-dot-${i}`);
                const label = document.getElementById(`step-label-${i}`);
                if (i <= currentStep) {
                    dot.classList.remove('bg-gray-300');
                    dot.classList.add('bg-brand-600');
                    label.classList.remove('text-gray-400');
                    label.classList.add('text-brand-600');
                } else {
                    dot.classList.add('bg-gray-300');
                    dot.classList.remove('bg-brand-600');
                    label.classList.add('text-gray-400');
                    label.classList.remove('text-brand-600');
                }
            }
            document.getElementById('backBtn').disabled = (currentStep === 1 && !isNestedStaffFlow);

            if (currentStep === totalSteps) {
                document.getElementById('nextBtn').innerText = isNestedStaffFlow ? 'Create & Return' : 'Save & Close';
            } else {
                document.getElementById('nextBtn').innerText = 'Next Step';
            }
            updatePreview(wizardMode);
        }

        function resetWizard() {
            currentStep = 1;
            hasUnsavedChanges = false;
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
            document.getElementById(`${wizardMode}-step-1`).classList.add('active');
            updateStepperUI();

            nameInput.value = '';
            descInput.value = '';
            document.querySelector('input[value="fixed"]').checked = true;
            updatePriceInput();
            document.getElementById('staffNameInput').value = '';
            document.getElementById('staffRoleInput').value = '';
            document.getElementById('staffRespInput').value = '';
            document.getElementById('transferNameInput').value = '';

            resetPreview();
        }

        // --- Live Simulator Logic ---
        let hasShownUserIntent = false;
        let hasShownBotAck = false;

        function updatePreview(mode) {
            if (mode === 'service') updateServicePreview();
            else if (mode === 'staff') updateStaffPreview();
            else if (mode === 'protocol') updateProtocolPreview();
            else if (mode === 'transfer') updateTransferPreview();
        }

        function updateServicePreview() {
            const serviceName = nameInput.value;
            const desc = descInput.value;
            const outcome = document.querySelector('input[name="outcome"]:checked').value;

            document.getElementById('transferConfig').style.display = outcome === 'transfer' ? 'block' : 'none';
            document.getElementById('bookConfig').style.display = outcome === 'book' ? 'block' : 'none';
            document.getElementById('infoConfig').style.display = outcome === 'info' ? 'block' : 'none';

            if (serviceName.length > 3 && !hasShownUserIntent) {
                addBubble('user', `I'm looking for help with <b>${serviceName}</b>.`);
                hasShownUserIntent = true;
                setTimeout(() => { addSystemMsg('Sophiie recognized intent: ' + serviceName); }, 600);
            }

            if (desc.length > 5 && !hasShownBotAck && hasShownUserIntent) {
                setTimeout(() => {
                    addBubble('bot', `I can definitely help with that. We handle ${serviceName} specifically by ${desc.substring(0, 20)}...`);
                    hasShownBotAck = true;
                }, 800);
            }

            if (currentStep === 3) {
                const existingOutcome = document.getElementById('outcomeBubble');
                if (existingOutcome) existingOutcome.remove();

                let icon = ''; let text = '';
                if (outcome === 'transfer') { icon = 'fa-phone-arrow-up-right'; text = 'Transferring call to team...'; }
                else if (outcome === 'book') { icon = 'fa-calendar-days'; text = 'Checking calendar availability...'; }
                else if (outcome === 'info') {
                    const sendSMS = document.getElementById('checkSMS').checked;
                    const sendEmail = document.getElementById('checkEmail').checked;
                    if (sendSMS && sendEmail) { icon = 'fa-envelopes-bulk'; text = 'Sending details via SMS & Email...'; }
                    else if (sendSMS) { icon = 'fa-comment-sms'; text = 'Sending details via SMS...'; }
                    else if (sendEmail) { icon = 'fa-envelope'; text = 'Sending details via Email...'; }
                    else { icon = 'fa-circle-question'; text = 'Select a delivery method...'; }
                }
                const bubbleHtml = `<div id="outcomeBubble" class="system-bubble text-brand-600 bg-brand-50 py-2 px-3 rounded-lg border border-brand-100 animate-fade-in mt-4"><i class="fa-solid ${icon}"></i> Action: ${text}</div>`;
                chatContainer.insertAdjacentHTML('beforeend', bubbleHtml);
                scrollToBottom();
            }
        }

        function updateStaffPreview() {
            const name = document.getElementById('staffNameInput').value || 'Sarah';
            const role = document.getElementById('staffRoleInput').value || 'Manager';
            const resp = document.getElementById('staffRespInput').value || 'billing';

            if (document.getElementById('sim-staff-1')) return;

            if (currentStep === 2 && resp.length > 5) {
                addBubble('user', `I have a tricky question about my ${resp.split(' ')[0]}.`);
                setTimeout(() => {
                    addSystemMsg(`Intent recognized: Matches ${name}'s responsibilities.`);
                    setTimeout(() => {
                        addBubble('bot', `I can help with that. Let me get you to ${name}, our ${role}, who handles that best.`);
                    }, 600);
                }, 500);
                const flag = document.createElement('div'); flag.id = 'sim-staff-1'; chatContainer.appendChild(flag);
            }

            if (currentStep === 3) {
                const existingOutcome = document.getElementById('outcomeBubbleStaff');
                if (existingOutcome) existingOutcome.remove();
                const bubbleHtml = `<div id="outcomeBubbleStaff" class="system-bubble text-brand-600 bg-brand-50 py-2 px-3 rounded-lg border border-brand-100 animate-fade-in mt-4"><i class="fa-solid fa-phone-arrow-up-right"></i> Rule: Transfer to ${name}</div>`;
                chatContainer.insertAdjacentHTML('beforeend', bubbleHtml);
                scrollToBottom();
            }
        }

        function updateProtocolPreview() {
            if (currentStep === 1) {
                // Just text change in Step 1, wait for Step 2 interaction
            } else if (currentStep === 2) {
                const action = document.getElementById('protocolActionSelect').value;
                const existingOutcome = document.getElementById('outcomeBubbleProtocol');
                if (existingOutcome) existingOutcome.remove();

                let text = "Action pending...";
                if (action === 'script') text = "Reading Script: We do not offer refunds...";
                if (action === 'transfer') text = "Action: Transfer to selected team";
                if (action === 'refuse') text = "Action: Politely decline request";
                if (action === 'collect') text = "Action: Collect details and save note";

                const bubbleHtml = `<div id="outcomeBubbleProtocol" class="system-bubble text-indigo-600 bg-indigo-50 py-2 px-3 rounded-lg border border-indigo-100 animate-fade-in mt-4"><i class="fa-solid fa-bolt"></i> Protocol: ${text}</div>`;
                chatContainer.insertAdjacentHTML('beforeend', bubbleHtml);
                scrollToBottom();
            }
        }

        function updateTransferPreview() {
            if (currentStep === 2) {
                const summary = document.getElementById('transferSummaryInput').value;
                // Show AI whispering to agent logic
                const existingOutcome = document.getElementById('outcomeBubbleTransfer');
                if (existingOutcome) existingOutcome.remove();

                // Parse mock variables for display
                let displaySummary = summary.replace('{Caller Name}', 'John').replace('{Reason}', 'a leaky tap').replace('{Key Details}', 'it is flooding the kitchen');

                const bubbleHtml = `<div id="outcomeBubbleTransfer" class="system-bubble text-orange-600 bg-orange-50 py-2 px-3 rounded-lg border border-orange-100 animate-fade-in mt-4 text-left"><div class="flex items-center gap-2 mb-1"><i class="fa-solid fa-user-headset"></i> <span class="font-bold text-xs uppercase">AI to Agent Whisper</span></div>"${displaySummary}"</div>`;
                chatContainer.insertAdjacentHTML('beforeend', bubbleHtml);
                scrollToBottom();
            }
        }

        // Add Question Logic
        function addQuestion() {
            const txt = newQuestionInput.value;
            if (!txt) return;
            hasUnsavedChanges = true;
            const div = document.createElement('div');
            div.className = 'flex gap-2 animate-fade-in';
            div.innerHTML = `<div class="flex-1 bg-gray-50 px-3 py-2.5 rounded-lg border border-gray-200 text-sm text-slate-700 flex items-center justify-between group"><span>${txt}</span><button onclick="this.parentElement.parentElement.remove(); hasUnsavedChanges=true;" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div>`;
            questionsList.appendChild(div);
            newQuestionInput.value = '';
        }

        function addBubble(type, html) {
            let bubbleHtml = '';
            if (type === 'user') bubbleHtml = `<div class="user-bubble chat-bubble">${html}</div>`;
            else bubbleHtml = `<div class="flex gap-3 animate-fade-in"><div class="w-8 h-8 rounded-full bg-brand-600 flex-shrink-0 flex items-center justify-center text-white text-xs"><i class="fa-solid fa-headset"></i></div><div class="bot-bubble chat-bubble">${html}</div></div>`;
            chatContainer.insertAdjacentHTML('beforeend', bubbleHtml);
            scrollToBottom();
        }

        function addSystemMsg(text) {
            const html = `<div class="system-bubble"><i class="fa-solid fa-bolt text-yellow-500"></i> ${text}</div>`;
            chatContainer.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function resetPreview() {
            chatContainer.innerHTML = `<div class="system-bubble"><i class="fa-solid fa-play"></i> Simulation Started</div><div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-brand-600 flex-shrink-0 flex items-center justify-center text-white text-xs"><i class="fa-solid fa-headset"></i></div><div class="bot-bubble chat-bubble">Hi, thanks for calling ABC Plumbing. How can I help you today?</div></div>`;
            hasShownUserIntent = false;
            hasShownBotAck = false;
        }

        // Protocol Trigger Logic
        function updateProtocolPlaceholder() {
            const type = document.querySelector('input[name="protocolTrigger"]:checked').value;
            const input = document.getElementById('protocolTriggerInput');
            if (type === 'keyword') {
                input.placeholder = "Enter specific keywords (comma separated)...";
            } else {
                input.placeholder = "Describe the user's goal (e.g., 'The user is angry about a bill')...";
            }
        }

        newQuestionInput.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                addQuestion();
            }
        });

    </script>
</body>

</html>